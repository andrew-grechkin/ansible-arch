---
- name: Install sddm
  become: true
  community.general.pacman:
    name: [sddm]

- name: Populate service facts
  ansible.builtin.service_facts: null

- name: Disable lightdm service
  become: true
  ansible.builtin.service:
    name: lightdm
    enabled: false
  when: "'lightdm.service' in ansible_facts.services and ansible_facts.services['lightdm.service'].state == 'running'"

- name: Enable sddm service
  become: true
  ansible.builtin.service:
    name: sddm
    enabled: true

- name: Copy sddm window manager vnc server
  become: true
  ansible.builtin.copy:
    dest: /etc/systemd/system/x0vncserver.service
    mode: '0644'
    owner: root
    group: root
    content: |-
      [Unit]
      Description=Remote desktop service (VNC) for :0 display
      Requires=display-manager.service
      After=network-online.target
      After=display-manager.service

      [Service]
      Type=simple
      ExecStartPre=/usr/bin/bash -c "/usr/bin/systemctl set-environment XAUTHORITY=$(find /var/run/sddm/ -type f)"
      ExecStart=/usr/bin/x0vncserver -display=:0 -rfbport=59000 -PAMService=login -PlainUsers="*" -SecurityTypes=TLSPlain
      Restart=on-failure
      RestartSec=500ms

      [Install]
      WantedBy=multi-user.target
